(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))t(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function s(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function t(o){if(o.ep)return;o.ep=!0;const r=s(o);fetch(o.href,r)}})();const V=4.18,Ne=287.058,Ce=461.52;function Ue(e){const n=e+273.15;if(n<=273.15||n>=647.096)return n<=273.15?611.21*Math.exp((18.678-e/234.5)*(e/(257.14+e))):0;const s=647.096,t=22064e3,o=n/s,r=[-7.85951783,1.84408259,-11.7866497,22.6807411,-15.9618719,1.80122502],i=1-o,a=r[0]*i+r[1]*Math.pow(i,1.5)+r[2]*Math.pow(i,3)+r[3]*Math.pow(i,3.5)+r[4]*Math.pow(i,4)+r[5]*Math.pow(i,7.5);return t*Math.exp(s/n*a)}function De(e){const n=e;return 1.00315*n+1306e-7*Math.pow(n,2)-46545e-12*Math.pow(n,3)+16368e-15*Math.pow(n,4)}function Ke(e){e<0&&(e=0),e>370&&(e=370);const n=e;return 2500.8+1.8325*n-551e-6*Math.pow(n,2)+3205e-9*Math.pow(n,3)-758e-11*Math.pow(n,4)}function ae(e,n){e<0&&(e=0);const s=n*1e5,t=e+273.15;let l=s*(-16318e-12+21268e-15*t+-61558e-19*Math.pow(t,2))+(1.0006+1579e-7*t+-16387e-10*Math.pow(t,2));return l<.95&&(l=.95),l>1.15&&(l=1.15),l}function je(e,n,s){const t=e+273.15,o=n*1e5,r=(.3344-364.2/t-75800/Math.pow(t,2))*1e-5,i=(-.198-1928/t)*1e-5,a=s/(.62198+s),d=1-a;return 1+(d*r+a*i)*o/((Ne*d+Ce*a)*t)}function D(e){return Ue(e)}function at(e,n,s){const t=n+273.15,o=e*1e5,r=D(n),a=ae(n,e)*r;let d=s/100*a;d>=o&&(d=o*.999);let c=o-d;c<0&&(c=0);const l=c<=0?10:.62198*(d/c),u=(Ne+l*Ce)/(1+l),m=je(n,e,l);if(m===0||u===0||t===0){const f=c/(Ne*t),v=d/(Ce*t);return f+v}return o/(m*u*t)}function dt(e,n,s){const t=e*1e5,o=D(n),i=ae(n,e)*o;let a=s/100*i;a>=t&&(a=t*.999);const d=t-a;return d<=0?10:.62198*(a/d)}function ct(e,n){(isNaN(n)||n<0)&&(n=0);const s=De(e),t=Ke(e);return s+n*t}function lt(e,n,s){n=Math.max(.1,Math.min(100,n));const t=D(e),o=ae(e,s),r=n/100*o*t;if(r<1)return-100;let i=-100,a=e,d=e/2;const c=ae(a,s)*D(a);if(r>=c)return e;for(let l=0;l<10;l++){d=(i+a)/2;const u=D(d);ae(d,s)*u-r>0?a=d:i=d}return d}function Je(e){return e<=0?2501:e>=374?0:Math.max(0,2501.6-2.369*e+.0018*e*e-4e-6*e*e*e)}function ut(e,n){const s=e*1e5;return n=Math.max(0,n),n*s/(.62198+n)}function ze(e){const n=Je(e);return V*e+n}function mt(e,n,s,t){const a=2*(n*Math.pow(s,(t-1)/t)-n);return e+a}function Xe(e){if(e<=0||isNaN(e))throw new Error("压力必须大于0");let n=.01,s=373;const t=.01,o=50,r=D(n);if(e<=r)return n;const i=D(s);if(e>=i)return s;for(let a=0;a<o;a++){const d=(n+s)/2,l=D(d)-e;if(Math.abs(l)<t||Math.abs(s-n)<t)return d;l>0?s=d:n=d}return(n+s)/2}function pt(e,n){if(isNaN(e)||e<=0)throw new Error("焓值无效");if(n<=0||isNaN(n))throw new Error("压力无效");const s=Xe(n),t=ze(s);if(e<=t)return s;const o=2,r=e-t,i=s+r/o;return Math.min(i,373)}const ft=Object.freeze(Object.defineProperty({__proto__:null,getAirDensity:at,getAirEnthalpy:ct,getCompressibilityFactor:je,getDewPoint:lt,getDryAirEnthalpy_HighAccuracy:De,getEnhancementFactor:ae,getHumidityRatio:dt,getIsentropicOutletEnthalpy:mt,getSatVaporPressure:D,getSatVaporPressure_HighAccuracy:Ue,getSaturatedSteamEnthalpy:ze,getSaturationTempFromPressure:Xe,getSteamLatentHeat:Je,getSteamTempFromEnthalpy:pt,getVaporEnthalpy_HighAccuracy:Ke,getVaporPressure:ut},Symbol.toStringTag,{value:"Module"})),{getDryAirEnthalpy_HighAccuracy:Pe,getVaporEnthalpy_HighAccuracy:_t,getEnhancementFactor:ht,getSatVaporPressure:W,getAirDensity:Ze,getHumidityRatio:J,getAirEnthalpy:_e,getDewPoint:Ye,getSteamLatentHeat:he,getVaporPressure:Re,getSaturatedSteamEnthalpy:Se,getIsentropicOutletEnthalpy:kt,getSaturationTempFromPressure:gt,getSteamTempFromEnthalpy:yt}=ft;let U=[],P=null,q=null;const fe=document.getElementById("hpCalcForm"),S=document.getElementById("calcButton"),et=document.getElementById("resetButton"),de=document.getElementById("results"),w=document.getElementById("resultMessage"),ue=document.getElementById("resultData");document.querySelectorAll('input[name="calcMode"]');document.querySelectorAll('input[name="inputType"]');const tt=document.getElementById("sourceType"),j=document.getElementById("sinkType"),wt=document.getElementById("sourceAirParams"),Et=document.getElementById("sourceSteamParams"),vt=document.getElementById("sinkAirParams"),Nt=document.getElementById("sinkTempGroup"),Ct=document.getElementById("sinkSteamParams"),Oe=document.getElementById("mvrModeBanner"),Lt=document.getElementById("etaType"),It=document.getElementById("customEtaGroup"),bt=document.getElementById("customCopGroup"),Fe=document.getElementById("sourceFlowGroup"),Ae=document.getElementById("sinkFlowGroup"),We=document.getElementById("sourceLoadGroup"),Ve=document.getElementById("sinkLoadGroup"),me=document.getElementById("sourceResultGroup"),pe=document.getElementById("sinkResultGroup"),Le=document.getElementById("sinkAirHumidPotGroup"),Ie=document.getElementById("sinkAirRHOutGroup"),be=document.getElementById("sinkEnergyEvapCapGroup"),Te=document.getElementById("sinkRHAfterHumidGroup"),Me=document.getElementById("sinkSteamMakeupWaterGroup"),x=document.getElementById("sourceUnit"),B=document.getElementById("sinkUnit"),ce=document.getElementById("resultActions"),Tt=document.getElementById("saveCaseButton"),Mt=document.getElementById("printSingleButton"),$e=document.getElementById("comparisonSection"),st=document.getElementById("comparisonTableContainer"),$t=document.getElementById("printComparisonButton"),xt=document.getElementById("clearCasesButton");let z={source:x.value,sink:B.value};x.addEventListener("mousedown",()=>{z.source=x.value});B.addEventListener("mousedown",()=>{z.sink=B.value});x.addEventListener("change",e=>{const n=e.target.value,s=z.source;nt(document.getElementById("sourceFlow"),s,n,tt.value),z.source=n});B.addEventListener("change",e=>{const n=e.target.value,s=z.sink;nt(document.getElementById("sinkFlow"),s,n,j.value),z.sink=n});function ge(){const e=document.querySelector('input[name="calcMode"]:checked').value,n=document.querySelector('input[name="inputType"]:checked').value,s=tt.value;let t=j.value;if(e==="source"?document.body.classList.add("mode-source-active"):document.body.classList.remove("mode-source-active"),s==="steam"){t!=="steam"&&(j.value="steam",t="steam");const i=j.querySelector('option[value="water"]'),a=j.querySelector('option[value="air"]');i&&(i.disabled=!0),a&&(a.disabled=!0)}else{const i=j.querySelector('option[value="water"]'),a=j.querySelector('option[value="air"]');i&&(i.disabled=!1),a&&(a.disabled=!1)}const o=s==="steam"&&t==="steam";if(Oe&&Oe.classList.toggle("hidden",!o),t=j.value,wt.classList.toggle("hidden",s!=="air"),Et.classList.toggle("hidden",s!=="steam"),vt.classList.toggle("hidden",t!=="air"),Nt.classList.toggle("hidden",t==="steam"),Ct.classList.toggle("hidden",t!=="steam"),Fe.classList.toggle("hidden",!(e==="source"&&n==="flow")),We.classList.toggle("hidden",!(e==="source"&&n==="load")),Ae.classList.toggle("hidden",!(e==="sink"&&n==="flow")),Ve.classList.toggle("hidden",!(e==="sink"&&n==="load")),o){const i=document.querySelector("fieldset:has(legend.text-source) .grid.grid-cols-1.sm\\:grid-cols-2");i&&(i.style.display="none")}else{const i=document.querySelector("fieldset:has(legend.text-source) .grid.grid-cols-1.sm\\:grid-cols-2");i&&(i.style.display="")}s==="water"?(x.options[0].disabled=!1,x.options[1].disabled=!1,x.options[2].disabled=!1):s==="air"&&(x.options[0].disabled=!0,x.options[1].disabled=!1,x.options[2].disabled=!1,x.value==="t/h"&&(x.value="m3/h")),t==="water"||t==="steam"?(B.options[0].disabled=!1,B.options[1].disabled=!1,B.options[2].disabled=!1):t==="air"&&(B.options[0].disabled=!0,B.options[1].disabled=!1,B.options[2].disabled=!1,B.value==="t/h"&&(B.value="m3/h")),z.source=x.value,z.sink=B.value;const r=Lt.value;It.classList.toggle("hidden",r!=="custom_eta"),bt.classList.toggle("hidden",r!=="custom_cop")}function ye(e,n=!0,s=[]){if(de.classList.remove("hidden"),w.classList.remove("hidden","bg-red-100","text-red-700","bg-green-100","text-green-700","bg-yellow-100","text-yellow-700","opacity-0"),w.classList.add("opacity-100"),n)P=null,q=null,ce.classList.add("hidden"),ue.classList.add("hidden"),w.classList.add("bg-red-100","text-red-700"),w.innerHTML=`<span class="font-bold">计算失败：</span> ${e}`,Bt();else{ue.classList.remove("hidden"),w.classList.add("bg-green-100","text-green-700");let t="";s&&s.length>0&&(t=`<div class="mt-2 p-3 text-sm rounded-md border text-left" style="background-color: #fffbeb; color: #92400e; border-color: #fde68a;">
                               <b>物理约束警告：</b><br>${s.join("<br>")}
                           </div>`),w.innerHTML=`<span class="font-bold">计算成功：</span> ${e} ${t}`,ce.classList.remove("hidden")}}function Bt(){["resFeasibility","resSourceSensible","resSourceLatent","resSourceWater","resSinkParam1Value","resSinkParam2Value","resSinkParam3Value","resSinkAirHumidPot","resSinkAirRHOut","resSinkEnergyEvapCap","resSinkRHAfterHumid","resSinkSteamMakeupWater","resQcold","resQhot","resW","resSourceFlow","resSinkFlow","resCopActual","resCopCarnot","resEta"].forEach(s=>{const t=document.getElementById(s);t&&(t.textContent="---")});const n=document.getElementById("resFeasibility");n&&(n.className="font-bold text-lg text-gray-700"),me&&me.classList.add("hidden"),pe&&pe.classList.add("hidden"),Le&&Le.classList.add("hidden"),Ie&&Ie.classList.add("hidden"),be&&be.classList.add("hidden"),Te&&Te.classList.add("hidden"),Me&&Me.classList.add("hidden")}function ke(e){if(ye(e.message,!e.feasibility,e.warnings||[]),!e.feasibility)return;const n=(d,c=2)=>d===null||typeof d>"u"||isNaN(d)?"---":d.toFixed(c),s=d=>`${n(d,2)} kW`,t=d=>`${n(d,3)} kg/h`,o=d=>`${n(d,1)} %`,r=document.getElementById("resFeasibility");r.textContent=e.feasibility?"可行":"不可行",r.className=e.feasibility?"font-bold text-lg text-green-600":"font-bold text-lg text-red-600",me.classList.toggle("hidden",e.source.type!=="air"),e.source.type==="air"&&(document.getElementById("resSourceSensible").textContent=s(e.source.qSensible),document.getElementById("resSourceLatent").textContent=s(e.source.qLatent),document.getElementById("resSourceWater").textContent=t(Math.abs(e.source.water_kg_h))),pe.classList.toggle("hidden",e.sink.type!=="air"&&e.sink.type!=="steam");const i=e.sink.type==="air",a=e.sink.type==="steam";if(Le.classList.toggle("hidden",!i),Ie.classList.toggle("hidden",!i),be.classList.toggle("hidden",!i),Te.classList.toggle("hidden",!i),Me.classList.toggle("hidden",!a),i)document.getElementById("resSinkParam1Label").textContent="显热负荷 (Q_sens)：",document.getElementById("resSinkParam1Value").textContent=s(e.sink.qSensible),document.getElementById("resSinkParam2Label").textContent="潜热负荷 (Q_lat)：",document.getElementById("resSinkParam2Value").textContent=s(e.sink.qLatent),document.getElementById("resSinkParam3Label").textContent="加湿/除湿水量：",document.getElementById("resSinkParam3Value").textContent=t(e.sink.water_kg_h),document.getElementById("resSinkAirHumidPot").textContent=t(e.sink.maxHumidPot_kg_h),document.getElementById("resSinkAirRHOut").textContent=o(e.sink.rhOut_noHumid),document.getElementById("resSinkEnergyEvapCap").textContent=t(e.sink.energyEvapCap_kg_h),document.getElementById("resSinkRHAfterHumid").textContent=o(e.sink.rhOut_afterHumid);else if(e.sink.type==="steam"){const d=W(e.sink.steamTemp)/1e5;document.getElementById("resSinkParam1Label").textContent="饱和压力：",document.getElementById("resSinkParam1Value").textContent=`${n(d,3)} bara`,document.getElementById("resSinkParam2Label").textContent="显热负荷 (Q_sens)：",document.getElementById("resSinkParam2Value").textContent=s(e.sink.qSensible),document.getElementById("resSinkParam3Label").textContent="潜热负荷 (Q_lat)：",document.getElementById("resSinkParam3Value").textContent=s(e.sink.qLatent);let c=null;e.isMVRMode&&e.makeupWaterFlow_t_h!==void 0?c=e.makeupWaterFlow_t_h:e.flow&&e.flow.sinkFlow!==null&&(c=e.flow.sinkFlow);const l="t/h";c!==null&&!isNaN(c)?document.getElementById("resSinkSteamMakeupWater").textContent=`${n(c,3)} ${l}`:document.getElementById("resSinkSteamMakeupWater").textContent="---"}document.getElementById("resQcold").textContent=s(e.qCold_kW),document.getElementById("resQhot").textContent=s(e.qHot_kW),document.getElementById("resW").textContent=s(e.W_kW),document.getElementById("resSourceFlow").textContent=e.flow.sourceFlow!==null?`${n(e.flow.sourceFlow)} ${e.flow.sourceUnit}`:"---",document.getElementById("resSinkFlow").textContent=e.flow.sinkFlow!==null?`${n(e.flow.sinkFlow)} ${e.flow.sinkUnit}`:"---",document.getElementById("resCopActual").textContent=n(e.copActual,2),document.getElementById("resCopCarnot").textContent=n(e.copCarnotMax,2),document.getElementById("resEta").textContent=`${n(e.etaActual*100,1)} %`}function nt(e,n,s,t){if(n===s)return;const o=parseFloat(e.value);if(isNaN(o)||o===0)return;let r;if(n==="t/h"?r=t==="air"?NaN:o:n==="L/min"?r=o*60/1e3:r=o,isNaN(r)){console.warn(`Conversion error: Cannot convert from ${n} for ${t}`);return}let i;if(s==="t/h"?i=t==="air"?NaN:r:s==="L/min"?i=r*1e3/60:i=r,isNaN(i)){console.warn(`Conversion error: Cannot convert to ${s} for ${t}`);return}e.value=parseFloat(i.toFixed(3))}fe.addEventListener("change",ge);let ve=null;fe.addEventListener("input",()=>{ve&&clearTimeout(ve),ve=setTimeout(()=>{de.classList.contains("hidden")||(w.classList.remove("hidden","bg-red-100","text-red-700","bg-green-100","text-green-700","opacity-0"),w.classList.add("bg-yellow-100","text-yellow-700","opacity-100"),w.innerHTML='<span class="font-bold">注意：</span> 输入参数已更改，请重新计算！',ue.classList.add("hidden"),ce.classList.add("hidden"),P=null,q=null,S.classList.remove("bg-[var(--color-action)]","hover:bg-orange-800"),S.classList.add("bg-yellow-500","hover:bg-yellow-600","animate-pulse"))},300)});et.addEventListener("click",()=>{fe.reset(),de.classList.add("hidden"),w.classList.add("hidden"),ue.classList.add("hidden"),ce.classList.add("hidden"),S.classList.remove("bg-yellow-500","hover:bg-yellow-600","animate-pulse"),S.classList.add("bg-[var(--color-action)]","hover:bg-orange-800"),document.getElementById("mode_source").checked=!0,document.getElementById("type_flow").checked=!0,document.getElementById("etaType").value="0.55",P=null,q=null,ot(),ge()});S.addEventListener("click",xe);Tt.addEventListener("click",Ot);xt.addEventListener("click",ot);Mt.addEventListener("click",()=>{if(!P||!q||!q.feasibility){alert("没有可打印的有效计算报告。");return}try{St(),document.body.classList.remove("printing-comparison"),document.body.classList.add("printing-single-report"),window.print(),setTimeout(()=>{document.body.classList.remove("printing-single-report"),document.getElementById("printReportContainer").innerHTML=""},500)}catch(e){console.error("Error generating print report:",e),alert("生成打印报告时出错："+e.message)}});$t.addEventListener("click",At);function xe(){S.classList.remove("bg-yellow-500","hover:bg-yellow-600","animate-pulse"),S.classList.add("bg-[var(--color-action)]","hover:bg-orange-800");try{const e=new FormData(fe),n=Object.fromEntries(e.entries());console.log("Form data:",n);const s=Pt(n);if(console.log("Parsed inputs:",s),s.isMVRMode){console.log("MVR mode detected, starting calculation...");let t,o;s.mode==="source"?(t=s.inputType==="flow"?ie(s.source,!0,!0):{type:s.source.type,q_kW:s.source.load||NaN,qSensible:NaN,qLatent:NaN,water_kg_h:0},o={type:s.sink.type,steamTemp:s.sink.steamTemp,q_kW:NaN,qSensible:NaN,qLatent:NaN,water_kg_h:0}):(o=s.inputType==="flow"?ie(s.sink,!0,!1):{type:s.sink.type,steamTemp:s.sink.steamTemp,q_kW:s.sink.load||NaN,qSensible:NaN,qLatent:NaN,water_kg_h:0},t={type:s.source.type,steamTemp:s.source.steamTemp,q_kW:NaN,qSensible:NaN,qLatent:NaN,water_kg_h:0});const r=Ht(s,t,o),i={...r,isMVRMode:!0,feasibility:r.mvrCOP>0?"可行":"不可行",qCold_kW:r.Q_cold_kW,qHot_kW:r.Q_hot_kW,W_kW:r.compressionWork_kW,copActual:r.mvrCOP,copCarnotMax:r.copCarnotMax,etaActual:r.etaActual,source:{type:"steam",steamTemp:s.source.steamTemp},sink:{type:"steam",steamTemp:s.sink.steamTemp},flow:{sourceFlow:r.steamFlow_t_h,sourceUnit:s.source.unit||"t/h",sinkFlow:r.sinkSteamFlow_t_h,sinkUnit:s.source.unit||"t/h"}};P=s,q=i,ke(i)}else{const t=s.mode==="source"&&s.inputType==="flow"?ie(s.source,!0,!0):{type:s.source.type,q_kW:NaN,qSensible:NaN,qLatent:NaN,water_kg_h:0},o=s.mode==="sink"&&s.inputType==="flow"?ie(s.sink,!0,!1):{type:s.sink.type,steamTemp:s.sink.steamTemp,q_kW:NaN,qSensible:NaN,qLatent:NaN,water_kg_h:0},r=Rt(s,t,o);P=s,q=r,ke(r)}}catch(e){console.error("Calculation Error:",e),console.error("Error details:",{message:e.message,stack:e.stack,inputs});const n=e.message||"发生未知计算错误，请检查输入参数。";throw ye(n,!1),X("计算失败："+n,"error"),e}}function Pt(e){const n=[],s=[],t={mode:e.calcMode,inputType:e.inputType,source:{},sink:{},eta:{},minTempApproach:3,steamTempApproach:5},o=(a,d,c=!1,l=-1/0,u=1/0)=>{if(a===null||String(a).trim()==="")return n.push(`${d} 不能为空。`),NaN;const m=parseFloat(a);return isNaN(m)||!c&&m<=0||m<l||m>u?(n.push(`${d} 必须是有效数字 (范围 ${l} ~ ${u})。`),NaN):m},r=(a,d,c=-1/0,l=1/0)=>{if(a===null||String(a).trim()==="")return null;const u=parseFloat(a);return isNaN(u)||u<c||u>l?(n.push(`${d} (选填) 必须是有效数字 (范围 ${c} ~ ${l})。`),NaN):u};t.source.type=e.sourceType;const i=t.source.type==="steam"&&e.sinkType==="steam";if(t.isMVRMode=i,t.source.type==="steam"?(t.source.steamTemp=o(e.sourceSteamTemp,"热源·饱和蒸汽温度",!0,1,250),t.source.steamPressure=r(e.sourceSteamPressure,"热源·蒸汽压力",.001,100)):(t.source.tempIn=o(e.sourceTempIn,"热源·进口温度",!0,-100,300),t.source.tempOut=o(e.sourceTempOut,"热源·出口温度",!0,-100,300),!isNaN(t.source.tempIn)&&!isNaN(t.source.tempOut)&&t.source.tempIn<=t.source.tempOut&&n.push("热源：进口温度必须高于出口温度。")),!i&&t.mode==="source"&&(t.inputType==="flow"?(t.source.flow=o(e.sourceFlow,"热源·可用流量"),t.source.unit=e.sourceUnit):t.source.load=o(e.sourceLoad,"热源·可用负荷")),t.source.type==="air"&&(t.source.pressure=o(e.sourceAirPressure,"热源·空气压力",!0,.1,20),t.source.rh=o(e.sourceAirRH,"热源·相对湿度",!0,0,100),!isNaN(t.source.tempIn)&&!isNaN(t.source.pressure)&&!isNaN(t.source.rh))){const a=t.source.pressure*1e5,d=W(t.source.tempIn);if(d>a){const c=a/d*100;t.source.rh>c&&s.push(`热源侧：在 ${t.source.tempIn}°C 和 ${t.source.pressure} bara 下，最大物理 RH 约为 ${c.toFixed(1)}%。输入值 ${t.source.rh}% 将按 ${c.toFixed(1)}% 极限值计算。`)}}if(t.sink.type=e.sinkType,t.sink.type==="steam")t.sink.steamTemp=o(e.sinkSteamTemp,"热汇·饱和蒸汽温度",!0,1,250),t.sink.makeupTemp=o(e.sinkMakeupWaterTemp,"热汇·补水温度",!0,-20,100),!isNaN(t.sink.makeupTemp)&&!isNaN(t.sink.steamTemp)&&t.sink.makeupTemp>=t.sink.steamTemp&&n.push("补水温度必须低于饱和蒸汽温度。");else if(t.sink.tempIn=o(e.sinkTempIn,"热汇·进口温度",!0,-100,300),t.sink.tempOut=o(e.sinkTempOut,"热汇·目标温度",!0,-100,300),!isNaN(t.sink.tempIn)&&!isNaN(t.sink.tempOut)&&t.sink.tempIn>=t.sink.tempOut&&n.push("热汇：进口温度必须低于目标温度。"),t.sink.type==="air"){if(t.sink.pressure=o(e.sinkAirPressure,"热汇·空气压力",!0,.1,20),t.sink.rh=o(e.sinkAirRH,"热汇·(进口)相对湿度",!0,0,100),t.sink.rhOut=r(e.sinkAirRHOut,"热汇·目标相对湿度",0,100),!isNaN(t.sink.tempIn)&&!isNaN(t.sink.pressure)&&!isNaN(t.sink.rh)){const a=t.sink.pressure*1e5,d=W(t.sink.tempIn);if(d>a){const c=a/d*100;t.sink.rh>c&&s.push(`热汇侧：在 ${t.sink.tempIn}°C 和 ${t.sink.pressure} bara 下，最大物理 RH 约为 ${c.toFixed(1)}%。输入值 ${t.sink.rh}% 将按 ${c.toFixed(1)}% 极限值计算。`)}}if(t.sink.rhOut!==null&&!isNaN(t.sink.rhOut)&&!isNaN(t.sink.tempOut)&&!isNaN(t.sink.pressure)){const a=t.sink.pressure*1e5,d=W(t.sink.tempOut);if(d>a){const c=a/d*100;t.sink.rhOut>c&&(s.push(`热汇侧：在 ${t.sink.tempOut}°C 和 ${t.sink.pressure} bara 下，最大物理 RH 约为 ${c.toFixed(1)}%。目标RH ${t.sink.rhOut}% 将按 ${c.toFixed(1)}% 极限值计算。`),t.sink.rhOut=c)}}}if(i?t.mode==="source"?t.inputType==="flow"?(t.source.flow=o(e.sourceFlow,"热源·蒸汽流量"),t.source.unit=e.sourceUnit):t.source.load=o(e.sourceLoad,"热源·可用负荷"):t.inputType==="flow"?(t.sink.flow=o(e.sinkFlow,"热汇·需求流量"),t.sink.unit=e.sinkUnit):t.sink.load=o(e.sinkLoad,"热汇·需求负荷"):t.mode==="sink"&&(t.inputType==="flow"?(t.sink.flow=o(e.sinkFlow,"热汇·需求流量"),t.sink.unit=e.sinkUnit):t.sink.load=o(e.sinkLoad,"热汇·需求负荷")),i&&(!isNaN(t.source.steamTemp)&&!isNaN(t.sink.steamTemp)&&t.source.steamTemp>=t.sink.steamTemp&&n.push("MVR模式：热源蒸汽温度必须低于热汇蒸汽温度。"),!isNaN(t.source.steamTemp)&&!isNaN(t.sink.steamTemp))){const a=t.source.steamPressure?t.source.steamPressure:W(t.source.steamTemp)/1e5,c=W(t.sink.steamTemp)/1e5/a;c<1.1&&s.push(`MVR模式：压缩比 ${c.toFixed(2)} 过低，建议压缩比 ≥ 1.1。`),c>10&&s.push(`MVR模式：压缩比 ${c.toFixed(2)} 过高，实际应用中压缩比通常 ≤ 10。`)}if(t.eta.type=e.etaType,t.eta.type==="custom_eta"?t.eta.customEta=o(e.customEta,"自定义 η",!1,.01,.99):t.eta.type==="custom_cop"?t.eta.customCop=o(e.customCop,"自定义 COP",!1,1.01):t.eta.customEta=parseFloat(t.eta.type),i?t.source.steamTemp:t.source.tempOut,t.sink.type==="steam"?t.sink.steamTemp:t.sink.tempIn,t.warnings=s,n.length>0)throw new Error(n.join("<br>"));return t}function re(e,n,s){if(!n||n<=0)throw new Error("用于反算流量的负荷无效。");if(e.type==="water"){const t=s?e.tempIn-e.tempOut:e.tempOut-e.tempIn;if(t<=0)throw new Error(s?"热源水侧温差必须大于0。":"热汇水侧温差必须大于0。");return{flow:n/(V*t)*3600/1e3,unit:"t/h"}}else if(e.type==="air"){const t=J(e.pressure,e.tempIn,e.rh),o=_e(e.tempIn,t);let r=t;s&&e.tempOut<Ye(e.tempIn,e.rh,e.pressure)?r=J(e.pressure,e.tempOut,100):!s&&e.tempOut>e.tempIn&&e.rhOut!==null&&typeof e.rhOut<"u"&&(r=J(e.pressure,e.tempOut,e.rhOut));const i=_e(e.tempOut,r),a=s?o-i:i-o;if(a===0)throw new Error(s?"热源空气焓差为0，无法反算流量。":"热汇空气焓差为0，无法反算流量。");if(s&&a<=0)throw new Error("热源空气焓差必须大于0。");if(!s&&a<=0)throw new Error("热汇空气总焓变必须大于0 (加热或加湿)。");const d=n/a,c=Ze(e.pressure,e.tempIn,e.rh);return{flow:d*(1+t)*3600/c,unit:"m³/h"}}else if(e.type==="steam"){const t=he(e.steamTemp),o=s?V*(e.steamTemp-(e.makeupTemp||20)):V*(e.steamTemp-e.makeupTemp),r=t+o;if(r<=0)throw new Error(`${s?"热源":"热汇"}蒸汽总焓变必须大于0。`);return{flow:n/r*3600/1e3,unit:"t/h"}}throw new Error("无法计算流量：未知的介质类型或配置。")}function ie(e,n,s){let t={type:e.type,mass_dry_air_kg_s:NaN,q_kW:NaN,qSensible:NaN,qLatent:NaN,water_kg_h:0};const o=e.flow,r=e.unit;if(e.type==="water"){const i=s?e.tempIn-e.tempOut:e.tempOut-e.tempIn;{let a=NaN;if(r==="t/h")a=o*1e3/3600;else if(r==="L/min")a=o/60;else if(r==="m3/h")a=o*1e3/3600;else throw new Error(`(热源: ${s}) 水介质的流量单位无效: ${r}。`);t.mass_dry_air_kg_s=a,t.q_kW=t.mass_dry_air_kg_s*V*i}t.qSensible=t.q_kW,t.qLatent=0}else if(e.type==="air"){const i=J(e.pressure,e.tempIn,e.rh),a=_e(e.tempIn,i);let d=i;s&&e.tempOut<Ye(e.tempIn,e.rh,e.pressure)?d=J(e.pressure,e.tempOut,100):!s&&e.tempOut>e.tempIn&&e.rhOut!==null&&typeof e.rhOut<"u"&&(d=J(e.pressure,e.tempOut,e.rhOut));const c=_e(e.tempOut,d),l=s?a-c:c-a;{const u=Ze(e.pressure,e.tempIn,e.rh);let m;if(r==="m3/h"||r==="m³/h")m=o*u/3600;else if(r==="L/min")m=o/1e3/60*u;else throw new Error(`(热源: ${s}) 空气介质的流量单位无效: ${r} (应为 m³/h 或 L/min)。`);t.mass_dry_air_kg_s=m/(1+i),t.q_kW=t.mass_dry_air_kg_s*l;const f=t.mass_dry_air_kg_s,v=Pe(e.tempIn),I=Pe(e.tempOut)-v;t.qSensible=f*Math.abs(I),t.qLatent=t.q_kW-t.qSensible,t.water_kg_h=f*(d-i)*3600,Math.abs(t.qLatent)<1e-6&&(t.qLatent=0),Math.abs(t.water_kg_h)<1e-6&&(t.water_kg_h=0),t.qLatent<0&&t.q_kW>0&&console.warn(`Negative latent heat (${t.qLatent} kW) calculated for ${s?"source":"sink"}. Resetting. Q_sensible adjusted.`)}}else if(e.type==="steam"){const i=he(e.steamTemp),a=s?V*(e.steamTemp-(e.makeupTemp||20)):V*(e.steamTemp-e.makeupTemp),d=i+a;{let c;if(r==="t/h")c=o*1e3/3600;else if(r==="L/min")c=o/60;else if(r==="m3/h"){const m=(e.steamPressure?e.steamPressure*1e5:W(e.steamTemp))/(461.52*(e.steamTemp+273.15));c=o*m/3600}else throw new Error(`${s?"热源":"热汇"}·蒸汽介质的流量单位无效: ${r}。`);t.mass_dry_air_kg_s=c,t.q_kW=t.mass_dry_air_kg_s*d,t.qSensible=t.mass_dry_air_kg_s*a,t.qLatent=t.mass_dry_air_kg_s*i}}return t}function Rt(e,n,s){const{source:t,sink:o,eta:r,minTempApproach:i,steamTempApproach:a,mode:d,inputType:c}=e;let l,u,m,f,v,_,I,h,k,C=null,O=null,K=null,H=null,M={...n},F={...s};const Z=t.tempOut-i,le=o.type==="steam"?o.steamTemp+a:o.tempOut+i,se=Z+273.15,ne=le+273.15;if(se>=ne)throw new Error(`热力学不可能：估算蒸发 (${Z.toFixed(1)}°C) >= 冷凝 (${le.toFixed(1)}°C)。`);const oe=ne/(ne-se);if(r.type==="custom_cop"?(f=r.customCop,v=f/oe):(v=r.customEta,f=oe*v),f<=1)throw new Error(`实际 COP (${f.toFixed(2)}) <= 1，不可行。`);if(d==="source"&&c==="flow"){if(l=n.q_kW,!l||l<=0)throw new Error("无法确定有效的制冷量。");m=l/(f-1),u=l+m,_=t.flow,I=t.unit;const{flow:N,unit:R}=re(o,u,!1);h=N,k=R}else if(d==="source"&&c==="load"){l=e.source.load,m=l/(f-1),u=l+m;const{flow:N,unit:R}=re(t,l,!0);_=N,I=R;const{flow:$,unit:L}=re(o,u,!1);h=$,k=L}else if(d==="sink"&&c==="flow"){if(u=s.q_kW,!u||u<=0)throw new Error("无法确定有效的制热量。");m=u/f,l=u-m;const{flow:N,unit:R}=re(t,l,!0);_=N,I=R,h=o.flow,k=o.unit}else{u=e.sink.load,m=u/f,l=u-m;const{flow:N,unit:R}=re(t,l,!0);_=N,I=R;const{flow:$,unit:L}=re(o,u,!1);h=$,k=L}if(M=ie({...t,flow:_,unit:I},!0,!0),F=ie({...o,flow:h,unit:k},!0,!1),o.type==="air")try{const N=J(o.pressure,o.tempIn,o.rh),R=J(o.pressure,o.tempOut,100);if(isNaN(F.mass_dry_air_kg_s)||F.mass_dry_air_kg_s<=0)throw new Error("无法计算干空气质量流量 (mass_dry_air_kg_s invalid)。");const $=F.mass_dry_air_kg_s;C=$*(R-N)*3600,C=Math.max(0,C);const L=W(o.tempOut),b=ht(o.tempOut,o.pressure),g=L*b,T=Re(o.pressure,N);g>0?(O=T/g*100,O=Math.max(0,Math.min(100,O))):O=0;const G=_t(o.tempOut)-V*o.tempOut;G>0?(K=u/G*3600,K=Math.max(0,K)):K=0;const Q=Math.min(C,K)/3600,we=$>0?N+Q/$:N,Y=Re(o.pressure,we);g>0?(H=Y/g*100,H=Math.max(0,Math.min(100,H))):H=0,o.rhOut!==null&&typeof o.rhOut<"u"&&(O=o.rhOut)}catch(N){console.error("Error calculating additional air sink parameters:",N),C=null,O=null,K=null,H=null}return{feasibility:!0,message:"初步匹配计算完成。",warnings:e.warnings||[],source:{type:t.type,qSensible:M.qSensible,qLatent:M.qLatent,water_kg_h:M.water_kg_h},sink:{type:o.type,steamTemp:o.steamTemp,qSensible:F.qSensible,qLatent:F.qLatent,water_kg_h:F.water_kg_h,maxHumidPot_kg_h:C,rhOut_noHumid:O,energyEvapCap_kg_h:K,rhOut_afterHumid:H},qCold_kW:l,qHot_kW:u,W_kW:m,copActual:f,copCarnotMax:oe,etaActual:v,flow:{sourceFlow:_,sourceUnit:I,sinkFlow:h,sinkUnit:k}}}function St(){const e=document.getElementById("printReportContainer");if(!e||!P||!q)throw new Error("Report container or data not found.");const n=P,s=q,t={name:document.getElementById("projectName").value||"未命名项目",desc:document.getElementById("projectDesc").value||"无"},o=(h,k=2)=>h===null||typeof h>"u"||isNaN(h)?"---":h.toFixed(k),r=h=>`${o(h,2)} kW`,i=h=>`${o(h,3)} kg/h`,a=h=>`${o(h,1)} %`,d=(h,k)=>h[k]||k,c=d({water:"水",air:"空气"},n.source.type),l=d({water:"水",air:"空气",steam:"蒸汽"},n.sink.type),u=d({source:"已知热源 (算热汇)",sink:"已知热汇 (算热源)"},n.mode),m=d({flow:"按流量计算",load:"按负荷计算"},n.inputType);let f="---";n.eta.type==="custom_eta"?f=`自定义 η (${o(n.eta.customEta,2)})`:n.eta.type==="custom_cop"?f=`自定义 COP (${o(n.eta.customCop,1)})`:f=`η = ${n.eta.type} (典型水平)`;const v=s.feasibility?"res-feasibility-ok":"res-feasibility-fail",_=n.sink.type==="air"&&n.sink.rhOut!==null&&typeof n.sink.rhOut<"u"?`<div><dt>热汇·目标RH：</dt><dd>${a(n.sink.rhOut)}</dd></div>`:"";let I=`
        <h1>工业热泵匹配计算报告</h1>
    
        <div class="report-section report-section-single">
            <h2>1. 项目信息</h2>
            <dl>
                <dt>项目名称：</dt><dd>${t.name}</dd>
                <dt>项目描述：</dt><dd>${t.desc}</dd>
            </dl>
        </div>

        <div class="report-section report-section-single">
            <h2>2. 计算结果总览</h2>
            <dl>
                <dt>匹配可行性：</dt><dd class="${v}">${s.feasibility?"可行":"不可行"}</dd>
                <dt>热泵制冷量 (Q_cold)：</dt><dd>${r(s.qCold_kW)}</dd>
                <dt>热泵制热量 (Q_hot)：</dt><dd class="res-qhot">${r(s.qHot_kW)}</dd>
                <dt>所需压缩机功 (W)：</dt><dd>${r(s.W_kW)}</dd>
                <dt>估算实际 COP_hot：</dt><dd class="res-cop">${o(s.copActual,2)}</dd>
                <dt>热力完善度 (η)：</dt><dd>${a(s.etaActual*100)}</dd>
            </dl>
        </div>
    
        <div class="report-section">
            <h2>3. 核心输入参数</h2>
            <div class="report-grid">
                <div class="report-subsection">
                    <h3>热源 (Source)</h3>
                    <dl>
                        <div><dt>介质类型：</dt><dd>${c}</dd></div>
                        <div><dt>进口温度：</dt><dd>${o(n.source.tempIn,1)} °C</dd></div>
                        <div><dt>出口温度：</dt><dd>${o(n.source.tempOut,1)} °C</dd></div>
                        ${n.source.type==="air"?`
                            <div><dt>空气压力：</dt><dd>${o(n.source.pressure,3)} bara</dd></div>
                            <div><dt>相对湿度：</dt><dd>${o(n.source.rh,1)} %</dd></div>
                        `:""}
                    </dl>
                </div>
                <div class="report-subsection">
                    <h3>热汇 (Sink)</h3>
                    <dl>
                        <div><dt>介质类型：</dt><dd>${l}</dd></div>
                        ${n.sink.type==="steam"?`
                            <div><dt>饱和蒸汽温度：</dt><dd>${o(n.sink.steamTemp,1)} °C</dd></div>
                            <div><dt>补水温度：</dt><dd>${o(n.sink.makeupTemp,1)} °C</dd></div>
                        `:`
                            <div><dt>进口温度：</dt><dd>${o(n.sink.tempIn,1)} °C</dd></div>
                            <div><dt>目标温度：</dt><dd>${o(n.sink.tempOut,1)} °C</dd></div>
                        `}
                        ${n.sink.type==="air"?`
                            <div><dt>空气压力：</dt><dd>${o(n.sink.pressure,3)} bara</dd></div>
                            <div><dt>进口RH：</dt><dd>${o(n.sink.rh,1)} %</dd></div>
                            ${_} 
                        `:""}
                    </dl>
                </div>
                <div class="report-subsection">
                    <h3>计算基准</h3>
                    <dl>
                        <div><dt>计算模式：</dt><dd>${u}</dd></div>
                        <div><dt>计算基准：</dt><dd>${m}</dd></div>
                        ${n.mode==="source"&&n.inputType==="flow"?`
                            <div><dt>热源·可用流量：</dt><dd>${o(n.source.flow)} ${n.source.unit}</dd></div>
                        `:""}
                        ${n.mode==="source"&&n.inputType==="load"?`
                            <div><dt>热源·可用负荷：</dt><dd>${r(n.source.load)}</dd></div>
                        `:""}
                        ${n.mode==="sink"&&n.inputType==="flow"?`
                            <div><dt>热汇·需求流量：</dt><dd>${o(n.sink.flow)} ${n.sink.unit}</dd></div>
                        `:""}
                        ${n.mode==="sink"&&n.inputType==="load"?`
                            <div><dt>热汇·需求负荷：</dt><dd>${r(n.sink.load)}</dd></div>
                        `:""}
                    </dl>
                </div>
                <div class="report-subsection">
                    <h3>性能估算</h3>
                    <dl>
                        <div><dt>估算方式：</dt><dd>${f}</dd></div>
                        <div><dt>卡诺(极限) COP_hot：</dt><dd>${o(s.copCarnotMax,2)}</dd></div>
                    </dl>
                </div>
            </div>
        </div>
        
        <div class="report-section">
            <h2>4. 详细输出参数</h2>
            <div class="report-grid">
                <div class="report-subsection">
                    <h3>流量计算</h3>
                    <dl>
                        <div><dt>热源·计算流量：</dt><dd>${o(s.flow.sourceFlow)} ${s.flow.sourceUnit}</dd></div>
                        <div><dt>热汇·计算流量：</dt><dd>${o(s.flow.sinkFlow)} ${s.flow.sinkUnit}</dd></div>
                    </dl>
                </div>
                <div class="report-subsection">
                    <h3>热源特性 (空气)</h3>
                    <dl>
                        ${n.source.type==="air"?`
                            <div><dt>显热负荷 (Q_sens)：</dt><dd>${r(s.source.qSensible)}</dd></div>
                            <div><dt>潜热负荷 (Q_lat)：</dt><dd>${r(s.source.qLatent)}</dd></div>
                            <div><dt>析出水量：</dt><dd>${i(s.source.water_kg_h)}</dd>
                        `:`
                            <div><dt> (热源介质为水)</dt><dd>---</dd></div>
                        `}
                    </dl>
                </div>
                <div class="report-subsection">
                    <h3>热汇特性 (空气/蒸汽)</h3>
                    <dl>
                        ${n.sink.type==="steam"?`
                            <div><dt>饱和压力：</dt><dd>${o(W(n.sink.steamTemp)/1e5,3)} bara</dd></div>
                            <div><dt>显热负荷 (Q_sens)：</dt><dd>${r(s.sink.qSensible)}</dd></div>
                            <div><dt>潜热负荷 (Q_lat)：</dt><dd>${r(s.sink.qLatent)}</dd></div>
                            <div><dt>补水量：</dt><dd>${s.flow.sinkFlow!==null?`${o(s.flow.sinkFlow)} ${s.flow.sinkUnit||"t/h"}`:"---"}</dd></div>
                        `:n.sink.type==="air"?`
                            <div><dt>显热负荷 (Q_sens)：</dt><dd>${r(s.sink.qSensible)}</dd></div>
                            <div><dt>潜热负荷 (Q_lat)：</dt><dd>${r(s.sink.qLatent)}</dd></div>
                            <div><dt>加湿/除湿水量：</dt><dd>${i(s.sink.water_kg_h)}</dd></div>
                            <div><dt>空气吸湿潜力：</dt><dd>${i(s.sink.maxHumidPot_kg_h)}</dd></div>
                            <div><dt>加热后RH(或目标RH)：</dt><dd>${a(s.sink.rhOut_noHumid)}</dd></div>
                            <div><dt>能量约束蒸发能力：</dt><dd>${i(s.sink.energyEvapCap_kg_h)}</dd></div>
                            <div><dt>最大加湿后RH：</dt><dd>${a(s.sink.rhOut_afterHumid)}</dd></div>
                        `:`
                            <div><dt> (热汇介质为水)</dt><dd>---</dd></div>
                        `}
                    </dl>
                </div>
            </div>
        </div>
    `;e.innerHTML=I}function Ot(){if(!P||!q){X("没有可暂存的有效计算结果。","warning");return}const e={inputs:JSON.parse(JSON.stringify(P)),result:JSON.parse(JSON.stringify(q))};U.push(e),Ft(),w.classList.remove("hidden","bg-red-100","text-red-700","bg-green-100","text-green-700","bg-yellow-100","text-yellow-700","opacity-0"),w.classList.add("bg-blue-100","text-blue-700","opacity-100"),w.innerHTML=`<span class="font-bold">方案 ${U.length} 已暂存。</span> 可在页面底部查看对比。`,X(`方案 ${U.length} 已暂存`,"success")}function Ft(){if(U.length===0){$e.classList.add("hidden");return}$e.classList.remove("hidden");const e=(s,t=2)=>s===null||typeof s>"u"||isNaN(s)?"---":s.toFixed(t);let n='<table class="comparison-table">';n+=`
        <thead>
            <tr>
                <th>方案</th>
                <th>基准</th>
                <th>热源</th>
                <th>热源 T_in (°C)</th>
                <th>热源 T_out (°C)</th>
                <th>热汇</th>
                <th>热汇 T_in (°C)</th>
                <th>热汇 T_out (°C)</th>
                <th>Q_cold (kW)</th>
                <th>Q_hot (kW)</th>
                <th>W (kW)</th>
                <th>COP_hot</th>
                <th>η (%)</th>
            </tr>
        </thead>
    `,n+="<tbody>",U.forEach((s,t)=>{const o=s.inputs,r=s.result,i=o.mode==="source"?"已知热源":"已知热汇",a=o.inputType==="flow"?"按流量":"按负荷",d=o.sink.type==="steam"?o.sink.makeupTemp:o.sink.tempIn,c=o.sink.type==="steam"?o.sink.steamTemp:o.sink.tempOut;n+=`
            <tr>
                <td>${t+1}</td>
                <td>${i} /<br>${a}</td>
                <td>${o.source.type==="air"?"空气":"水"}</td>
                <td>${e(o.source.tempIn,1)}</td>
                <td>${e(o.source.tempOut,1)}</td>
                <td>${o.sink.type==="air"?"空气":o.sink.type==="steam"?"蒸汽":"水"}</td>
                <td>${e(d,1)}</td>
                <td>${e(c,1)}</td>
                <td class="param-output">${e(r.qCold_kW)}</td>
                <td class="param-output param-qhot">${e(r.qHot_kW)}</td>
                <td class="param-output">${e(r.W_kW)}</td>
                <td class="param-output param-cop">${e(r.copActual)}</td>
                <td class="param-output">${e(r.etaActual*100,1)}</td>
            </tr>
        `}),n+="</tbody></table>",st.innerHTML=n}function ot(){const e=()=>{const n=U.length;U=[],st.innerHTML="",$e.classList.add("hidden"),w&&(w.classList.contains("bg-green-100")||w.classList.contains("bg-blue-100"))&&(w.classList.add("hidden"),w.innerHTML=""),n>0&&X("所有方案已清空","info")};U.length>0?confirm(`确定要清空所有 ${U.length} 个已暂存的方案吗？`)&&e():e()}function At(){if(U.length===0){alert("没有可打印的对比方案。");return}document.body.classList.add("printing-comparison"),window.print(),setTimeout(()=>{document.body.classList.remove("printing-comparison")},500)}function X(e,n="info",s=3e3){const t=document.getElementById("toastContainer");if(!t)return;const o=document.createElement("div");o.className=`toast ${n}`;const r={success:'<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',error:'<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',warning:'<svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>',info:'<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'};o.innerHTML=`
        ${r[n]||r.info}
        <span class="flex-1 text-sm text-gray-700">${e}</span>
        <button onclick="this.parentElement.remove()" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `,t.appendChild(o),setTimeout(()=>{o.classList.add("fade-out"),setTimeout(()=>o.remove(),300)},s)}function qe(e){const n=e.value.trim(),s=e.name,t=e.parentElement.nextElementSibling;if(e.classList.remove("error","success"),t&&t.classList.contains("error-message")&&(t.classList.add("hidden"),t.textContent=""),!n&&!e.required)return!0;let o=!0,r="";if(s.includes("Temp")){const i=parseFloat(n);isNaN(i)?(o=!1,r="请输入有效数字"):(i<-100||i>300)&&(o=!1,r="温度范围：-100°C ~ 300°C")}if(s.includes("RH")){const i=parseFloat(n);isNaN(i)?(o=!1,r="请输入有效数字"):(i<0||i>100)&&(o=!1,r="相对湿度范围：0% ~ 100%")}if(s.includes("Pressure")){const i=parseFloat(n);isNaN(i)?(o=!1,r="请输入有效数字"):(i<.1||i>20)&&(o=!1,r="压力范围：0.1 ~ 20 bara")}if(s.includes("Flow")||s.includes("Load")){const i=parseFloat(n);(isNaN(i)||i<=0)&&(o=!1,r="请输入大于0的有效数字")}return o&&n?e.classList.add("success"):o||(e.classList.add("error"),t&&t.classList.contains("error-message")&&(t.textContent=r,t.classList.remove("hidden"))),o}function Wt(){const e=fe.querySelectorAll('input[type="number"], input[type="text"], textarea'),n=new Map;e.forEach(s=>{s.addEventListener("blur",()=>qe(s)),s.addEventListener("input",()=>{if(s.classList.contains("error")){s.classList.remove("error");const o=s.parentElement.nextElementSibling;o&&o.classList.contains("error-message")&&o.classList.add("hidden")}n.has(s)&&clearTimeout(n.get(s));const t=setTimeout(()=>{document.activeElement!==s&&qe(s)},500);n.set(s,t)})})}function Vt(){document.addEventListener("keydown",e=>{e.key==="Enter"&&!e.target.matches('textarea, input[type="text"]')&&(e.preventDefault(),S.disabled||S.click()),e.key==="Escape"&&et.click()})}function qt(){document.getElementById("projectName").value="示例项目",document.getElementById("projectDesc").value="这是一个示例项目，用于演示计算器的功能",document.getElementById("mode_source").checked=!0,document.getElementById("type_flow").checked=!0,document.getElementById("sourceType").value="water",document.getElementById("sourceTempIn").value="30",document.getElementById("sourceTempOut").value="25",document.getElementById("sourceFlow").value="100",document.getElementById("sourceUnit").value="t/h",document.getElementById("sinkType").value="water",document.getElementById("sinkTempIn").value="50",document.getElementById("sinkTempOut").value="70",document.getElementById("etaType").value="0.55",ge(),X("示例数据已填充","success")}function He(e){const n=document.getElementById("calcLoadingSpinner"),s=S.querySelector("span");e?(S.disabled=!0,n.classList.remove("hidden"),s.textContent="计算中..."):(S.disabled=!1,n.classList.add("hidden"),s.textContent="开始计算")}function Ht(e,n,s){let r;if(e.eta.type==="custom_cop"){const p=e.sink.steamTemp+273.15,y=e.source.steamTemp+273.15,A=p-y,E=p/A;r=e.eta.customCop/E}else r=e.eta.customEta;const i=r,a=.9;if(!e.source.steamTemp||isNaN(e.source.steamTemp))throw new Error("MVR模式：热源蒸汽温度无效。");if(!e.sink.steamTemp||isNaN(e.sink.steamTemp))throw new Error("MVR模式：热汇蒸汽温度无效。");if(!e.sink.makeupTemp||isNaN(e.sink.makeupTemp))throw new Error("MVR模式：热汇补水温度无效。");const d=e.source.steamPressure?e.source.steamPressure*1e5:W(e.source.steamTemp),c=W(e.sink.steamTemp);if(!d||isNaN(d)||d<=0)throw new Error("MVR模式：热源蒸汽压力无效，请检查热源蒸汽温度或手动输入压力。");if(!c||isNaN(c)||c<=0)throw new Error("MVR模式：热汇蒸汽压力无效，请检查热汇蒸汽温度。");const l=d/1e5,u=c/1e5;if(l<=0)throw new Error("MVR模式：热源压力必须大于0。");const m=u/l;if(isNaN(m)||m<=0)throw new Error("MVR模式：压缩比计算无效，请检查热源和热汇的蒸汽温度。");const f=he(e.sink.steamTemp),v=V*(e.sink.steamTemp-e.sink.makeupTemp),_=f+v;if(!_||isNaN(_)||_<=0)throw new Error("MVR模式：热汇总焓计算无效，请检查热汇蒸汽温度和补水温度。");const I=he(e.source.steamTemp),h=V*(e.source.steamTemp-20),k=I+h;if(!k||isNaN(k)||k<=0)throw new Error("MVR模式：热源总焓计算无效，请检查热源蒸汽温度。");const C=e.source.steamTemp+273.15,O=Se(e.source.steamTemp),H=kt(O,C,m,1.33)-O;if(isNaN(H))throw new Error("MVR模式：等熵压缩功计算失败，请检查输入参数。");if(H<0)throw new Error("MVR模式：等熵压缩功为负值，热源温度必须低于热汇温度。");if(i<=0||i>1)throw new Error("MVR模式：等熵效率无效。");const M=H/i;if(isNaN(M)||M<=0)throw new Error("MVR模式：实际压缩功计算无效，请检查输入参数。");const F=O+M,Z=gt(c),le=Se(Z),se=yt(F,c),ne=se>Z,oe=e.sink.steamTemp+273.15,N=e.source.steamTemp+273.15,R=oe-N;if(R<=0)throw new Error("MVR模式：热汇温度必须高于热源温度。");const $=oe/R;if(isNaN($)||$<=0)throw new Error("MVR模式：卡诺极限COP计算无效。");let L,b,g,T;if(e.mode==="source")if(e.inputType==="flow"){const p=e.source.flow;if(!p||isNaN(p)||p<=0)throw new Error("MVR模式：热源蒸汽流量无效，请输入有效的流量值。");const y=e.source.unit||"t/h";if(y==="t/h")g=p*1e3/3600;else if(y==="m3/h"){if(C<=0||isNaN(C))throw new Error("MVR模式：热源温度无效，无法计算体积流量。");const E=d/(461.52*C);if(isNaN(E)||E<=0)throw new Error("MVR模式：蒸汽密度计算无效，请检查热源压力和温度。");g=p*E/3600}else if(y==="L/min"){if(C<=0||isNaN(C))throw new Error("MVR模式：热源温度无效，无法计算体积流量。");const E=d/(461.52*C);if(isNaN(E)||E<=0)throw new Error("MVR模式：蒸汽密度计算无效，请检查热源压力和温度。");g=p*E/60}else throw new Error(`MVR模式：不支持的流量单位 ${y}，请使用 t/h、m³/h 或 L/min。`);L=g*k;const A=g*M;if(b=L+A,_<=0||isNaN(_))throw new Error("MVR模式：热汇总焓无效，无法计算热汇流量。");T=b/_}else{const p=e.source.load;if(!p||isNaN(p)||p<=0)throw new Error("MVR模式：热源可用负荷无效，请输入有效的负荷值。");if(k<=0)throw new Error("MVR模式：热源总焓无效，请检查热源蒸汽温度。");L=p,g=L/k;const y=g*M;if(b=L+y,_<=0||isNaN(_))throw new Error("MVR模式：热汇总焓无效，无法计算热汇流量。");T=b/_}else if(e.inputType==="flow"){const p=e.sink.flow;if(!p||isNaN(p)||p<=0)throw new Error("MVR模式：热汇蒸汽流量无效，请输入有效的流量值。");const y=e.sink.unit||"t/h";if(y==="t/h")T=p*1e3/3600;else if(y==="m3/h"){const E=e.sink.steamTemp+273.15;if(E<=0||isNaN(E))throw new Error("MVR模式：热汇温度无效，无法计算体积流量。");const te=c/(461.52*E);if(isNaN(te)||te<=0)throw new Error("MVR模式：蒸汽密度计算无效，请检查热汇压力和温度。");T=p*te/3600}else if(y==="L/min"){const E=e.sink.steamTemp+273.15;if(E<=0||isNaN(E))throw new Error("MVR模式：热汇温度无效，无法计算体积流量。");const te=c/(461.52*E);if(isNaN(te)||te<=0)throw new Error("MVR模式：蒸汽密度计算无效，请检查热汇压力和温度。");T=p*te/60}else throw new Error(`MVR模式：不支持的流量单位 ${y}，请使用 t/h、m³/h 或 L/min。`);if(b=T*_,k<=0)throw new Error("MVR模式：热源总焓无效，请检查热源蒸汽温度。");const A=k+M;if(A<=0||isNaN(A))throw new Error("MVR模式：计算分母无效，请检查输入参数。");g=b/A,L=g*k}else{const p=e.sink.load;if(!p||isNaN(p)||p<=0)throw new Error("MVR模式：热汇需求负荷无效，请输入有效的负荷值。");if(_<=0)throw new Error("MVR模式：热汇总焓无效，请检查热汇蒸汽温度。");if(b=p,T=b/_,k<=0)throw new Error("MVR模式：热源总焓无效，请检查热源蒸汽温度。");const y=k+M;if(y<=0||isNaN(y))throw new Error("MVR模式：计算分母无效，请检查输入参数。");g=b/y,L=g*k}if(g<=0||isNaN(g))throw new Error("MVR模式：计算出的热源蒸汽质量流量无效，请检查输入参数。");let G=0;if(ne&&se>Z){const p=V*e.sink.makeupTemp,y=F,A=le;p<A?(G=g*(A-y)/(p-A),G=Math.max(0,G)):G=0}else G=0;const Be=G*3600/1e3;if(T=g+G,T<=0||isNaN(T))throw new Error("MVR模式：计算出的热汇蒸汽质量流量无效，请检查输入参数。");const Q=g*M;if(b=L+Q,isNaN(Q)||Q<=0)throw new Error("MVR模式：压缩功计算无效，请检查输入参数。");const we=Q/a;if(Q<=0||isNaN(Q))throw new Error("MVR模式：压缩功无效，无法计算MVR COP。");const Y=b/Q;if(isNaN(Y)||Y<=0)throw new Error("MVR模式：MVR COP计算无效，请检查输入参数。");let ee;if(e.eta.type==="custom_cop"?ee=e.eta.customCop/$:ee=e.eta.customEta,isNaN(ee)||ee<=0||ee>1)throw new Error("MVR模式：热力完善度无效，请检查输入参数。");const Ee=$*ee;Math.abs(Y-Ee)/Ee>.05&&console.info(`MVR模式：计算出的COP(${Y.toFixed(2)})与基于热力完善度的期望COP(${Ee.toFixed(2)})有差异，这是正常的，因为压缩功计算考虑了等熵效率等因素。`);const rt=e.sink.steamTemp-e.source.steamTemp,it=C*Math.pow(m,(1.33-1)/1.33)-273.15;return{compressionRatio:m,compressionWork_kW:Q,shaftPower_kW:we,mvrCOP:Y,copCarnotMax:$,etaActual:ee,etaIsentropic:i,etaMechanical:a,tempLift_C:rt,tempLiftIsentropic_C:it-e.source.steamTemp,steamFlow_t_h:g*3600/1e3,sinkSteamFlow_t_h:T*3600/1e3,makeupWaterFlow_t_h:Be,sourcePressure_bara:l,sinkPressure_bara:u,Q_cold_kW:L,Q_hot_kW:b,massFlow_kg_s:g,sinkMassFlow_kg_s:T,outletTempActual_C:se,outletTempSaturated_C:Z,isOutletSuperheated:ne,outletEnthalpy_kJ_kg:F,saturatedEnthalpy_kJ_kg:le}}function Gt(e){const n=document.getElementById("selectionCriteria");if(!n||!e.feasibility||!P)return;n.classList.remove("hidden");const s=P.source,t=P.sink,o=`${s.tempOut} ~ ${s.tempIn} °C`,i={water:"水",air:"空气",steam:"蒸汽"}[s.type]||s.type,a=s.flow?`${s.flow} ${s.unit||"t/h"}`:"---",d=e.qCold_kW?`${e.qCold_kW.toFixed(1)} kW`:"---";document.getElementById("criteriaSourceTempRange").textContent=o,document.getElementById("criteriaSourceMedia").textContent=i,document.getElementById("criteriaSourceFlow").textContent=a,document.getElementById("criteriaSourceLoad").textContent=d;const c=`${t.tempIn} ~ ${t.tempOut} °C`,u={water:"水",air:"空气",steam:"蒸汽"}[t.type]||t.type,m=t.flow?`${t.flow} ${t.unit||"t/h"}`:"---",f=e.qHot_kW?`${e.qHot_kW.toFixed(1)} kW`:"---";document.getElementById("criteriaSinkTempRange").textContent=c,document.getElementById("criteriaSinkMedia").textContent=u,document.getElementById("criteriaSinkFlow").textContent=m,document.getElementById("criteriaSinkLoad").textContent=f;const v=t.tempOut-s.tempIn,_=v>0?`+${v.toFixed(1)} °C`:`${v.toFixed(1)} °C`,I=e.copActual?e.copActual.toFixed(2):"---",h=e.W_kW?`${e.W_kW.toFixed(1)} kW`:"---";document.getElementById("criteriaTempLift").textContent=_,document.getElementById("criteriaCopRequired").textContent=I,document.getElementById("criteriaCompressorPower").textContent=h}function Ge(e){if(!e.feasibility)return;const n=document.querySelector("#copProgressBar > div"),s=document.getElementById("copProgressBar");if(n&&e.copActual&&e.copCarnotMax){const r=Math.min(e.copActual/e.copCarnotMax*100,100);n.style.width=r+"%",s.classList.remove("hidden")}const t=document.querySelector("#etaProgressBar > div"),o=document.getElementById("etaProgressBar");if(t&&e.etaActual){const r=e.etaActual*100;t.style.width=r+"%",o.classList.remove("hidden")}}function Qt(e){const n=document.getElementById("mvrResults");if(!n)return;n.classList.remove("hidden");const s=(o,r=2)=>o===null||typeof o>"u"||isNaN(o)?"---":o.toFixed(r),t=(o,r)=>{const i=document.getElementById(o);i&&(i.textContent=r)};t("mvrCompressionRatio",s(e.compressionRatio,2)),t("mvrCompressionWork",`${s(e.compressionWork_kW,2)} kW`),t("mvrCOP",s(e.mvrCOP,2)),t("mvrTempLift",`${s(e.tempLift_C,1)} °C`),t("mvrSteamFlow",`${s(e.steamFlow_t_h,2)} t/h`),t("mvrSourcePressure",`${s(e.sourcePressure_bara,3)} bara`),t("mvrSinkPressure",`${s(e.sinkPressure_bara,3)} bara`),e.shaftPower_kW!==void 0&&t("mvrShaftPower",`${s(e.shaftPower_kW,2)} kW`),e.etaIsentropic!==void 0&&t("mvrEtaIsentropic",`${s(e.etaIsentropic*100,1)} %`),e.tempLiftIsentropic_C!==void 0&&t("mvrTempLiftIsentropic",`${s(e.tempLiftIsentropic_C,1)} °C`)}const Ut=ke;ke=function(e){if(e.isMVRMode){de.classList.remove("hidden"),ue.classList.remove("hidden"),w.classList.remove("hidden"),document.getElementById("mvrResults");const n=document.getElementById("selectionCriteria");n&&n.classList.add("hidden"),Qt(e);const s=(r,i=2)=>r===null||typeof r>"u"||isNaN(r)?"---":r.toFixed(i),t=r=>`${s(r,2)} kW`;ye(e.feasibility?"MVR计算完成":"MVR计算失败",!e.feasibility);const o=document.getElementById("resFeasibility");if(o&&(o.textContent=e.feasibility?"可行":"不可行",o.className=e.feasibility?"font-bold text-lg text-green-600":"font-bold text-lg text-red-600"),me&&me.classList.add("hidden"),pe&&pe.classList.add("hidden"),document.getElementById("resQcold")&&(document.getElementById("resQcold").textContent=t(e.Q_cold_kW)),document.getElementById("resQhot")&&(document.getElementById("resQhot").textContent=t(e.Q_hot_kW)),document.getElementById("resW")&&(document.getElementById("resW").textContent=t(e.compressionWork_kW)),document.getElementById("resSourceFlow")&&(document.getElementById("resSourceFlow").textContent=`${s(e.steamFlow_t_h,2)} t/h`),document.getElementById("resSinkFlow")){const r=e.sinkSteamFlow_t_h!==void 0?e.sinkSteamFlow_t_h:e.steamFlow_t_h;document.getElementById("resSinkFlow").textContent=`${s(r,2)} t/h`}document.getElementById("resCopActual")&&(document.getElementById("resCopActual").textContent=s(e.mvrCOP,2)),document.getElementById("resCopCarnot")&&(document.getElementById("resCopCarnot").textContent=s(e.copCarnotMax,2)),document.getElementById("resEta")&&(document.getElementById("resEta").textContent=`${s(e.etaActual*100,1)} %`),Ge(e),ce&&ce.classList.remove("hidden"),X("MVR计算完成！","success"),de.scrollIntoView({behavior:"smooth",block:"nearest"})}else{Ut(e);const n=document.getElementById("mvrResults");n&&n.classList.add("hidden"),e.feasibility&&(X("计算完成！","success"),setTimeout(()=>{Gt(e),Ge(e)},100),de.scrollIntoView({behavior:"smooth",block:"nearest"}))}};const Dt=xe;xe=function(){He(!0),setTimeout(()=>{try{Dt()}catch(e){console.error("PerformCalculation wrapper error:",e),X("计算失败："+(e.message||"未知错误"),"error"),ye(e.message||"发生未知计算错误，请检查输入参数。",!1)}finally{He(!1)}},100)};const Qe=document.getElementById("fillExampleButton");Qe&&Qe.addEventListener("click",qt);ge();Wt();Vt();console.log("工业热泵匹配计算器 V6.0.0 初始化完成。");
